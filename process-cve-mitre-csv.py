#!/usr/bin/env python3

import csv
import re
import json

CVE_count_data = {  1999: {"CVE_count":0, "assignedInYear":0},
                    2000: {"CVE_count":0, "assignedInYear":0},
                    2001: {"CVE_count":0, "assignedInYear":0},
                    2002: {"CVE_count":0, "assignedInYear":0},
                    2003: {"CVE_count":0, "assignedInYear":0},
                    2004: {"CVE_count":0, "assignedInYear":0},
                    2005: {"CVE_count":0, "assignedInYear":0},
                    2006: {"CVE_count":0, "assignedInYear":0},
                    2007: {"CVE_count":0, "assignedInYear":0},
                    2008: {"CVE_count":0, "assignedInYear":0},
                    2009: {"CVE_count":0, "assignedInYear":0},
                    2010: {"CVE_count":0, "assignedInYear":0},
                    2011: {"CVE_count":0, "assignedInYear":0},
                    2012: {"CVE_count":0, "assignedInYear":0},
                    2013: {"CVE_count":0, "assignedInYear":0},
                    2014: {"CVE_count":0, "assignedInYear":0},
                    2015: {"CVE_count":0, "assignedInYear":0},
                    2016: {"CVE_count":0, "assignedInYear":0},
                    2017: {"CVE_count":0, "assignedInYear":0},
                    2018: {"CVE_count":0, "assignedInYear":0},
                    2019: {"CVE_count":0, "assignedInYear":0},
                    2020: {"CVE_count":0, "assignedInYear":0},
                    2021: {"CVE_count":0, "assignedInYear":0},
                    2022: {"CVE_count":0, "assignedInYear":0}
}

with open('allitems.csv', newline='',  encoding='ISO-8859-1') as csvfile:
    cvereader= csv.reader(csvfile, delimiter=',', quotechar='"')
    for row in cvereader:
        if re.search('^CVE-', row[0]):
            # Ignore reserved
            if re.search('^\*\* RESERVED \*\* ', row[2]):
                pass
            else:
                data_CVE=row[0]
                data_CVEYear=re.sub('^CVE-', '', row[0])
                data_CVEYear=re.sub('-[0-9]*$', '', data_CVEYear)

                # If we have an assignedDate value use it
                if re.search('Assigned \(', row[4]):
                    data_assignedDateYear=re.sub('^Assigned \(', '', row[4])
                    data_assignedDateYear=re.sub('[0-9][0-9][0-9][0-9]\)$', '', data_assignedDateYear)

                # If we do not have an assignedDate use the CVE year
                else:
                    data_assignedDateYear=data_CVEYear

                # Add logic to check for reserved IDs
                if int(data_assignedDateYear) < int(data_CVEYear):
                    data_Year_Used = data_CVEYear
                else:
                    data_Year_Used = data_assignedDateYear

                CVE_count_data[int(data_CVEYear)]["CVE_count"] += 1
                CVE_count_data[int(data_Year_Used)]["assignedInYear"] += 1

#                print(data_CVE + "," + data_CVEYear + "," + data_assignedDateYear + "," + data_Year_Used)

# TODO: conmvert to CSV, generate chart?

print(json.dumps(CVE_count_data, sort_keys=True, indent=4))
